Imports System
Imports System.IO
Imports System.Windows.Forms

Public Class BillingAndPaymentForm
    Inherits Form

    ' Payment table data
    Private paymentTable As New Dictionary(Of String, Decimal) From {
        {"Initial Check up", 2000},
        {"Follow up Check-Up", 500},
        {"Iron Vitamin", 15},
        {"B Complex", 25},
        {"DHA", 20},
        {"Flu Vac", 1500}
    }

    Private currentPatientPhone As String
    Private patientData As String()
    Private scheduleData As String()
    Private totalAmountDue As Decimal = 0
    Private visitTypePrice As Decimal = 0

    ' Add this flag to track if payment was completed
    Private paymentCompleted As Boolean = False

    Public Sub New(phoneNumber As String)
        InitializeComponent()
        currentPatientPhone = phoneNumber
        paymentCompleted = False
        ClearForm()
    End Sub

    Private Sub Form7_Load(sender As Object, e As EventArgs) Handles MyBase.Load
        AddHandler txtAmtPaid.TextChanged, AddressOf CalculateChange

        ' Make checkboxes read-only
        chbInitial.Enabled = False
        chbFollow.Enabled = False

        ' Only load data if payment hasn't been completed in this session
        If Not paymentCompleted Then
            LoadPatientData()
        End If
    End Sub

    Private Sub ClearForm()
        ' Clear all text boxes
        txtFullName.Clear()
        txtPhoneNumber.Clear()
        txtVisit.Clear()
        txtVisitPrice.Clear()
        txtIronVitamin.Clear()
        txtIronVitaminPrice.Clear()
        txtBComplex.Clear()
        txtBComplexPrice.Clear()
        txtDHA.Clear()
        txtDHAPrice.Clear()
        txtFluVaccine.Clear()
        txtFluVaccinePrice.Clear()
        txtTotal.Clear()
        txtTotalAmt.Clear()
        txtAmtPaid.Clear()
        txtChange.Clear()
        txtStatus.Clear()

        ' Reset checkboxes
        chbInitial.Checked = False
        chbFollow.Checked = False

        ' Reset amounts
        totalAmountDue = 0
        visitTypePrice = 0

        ' Reset data arrays
        patientData = Nothing
        scheduleData = Nothing

        ' Reset phone number (optional, you might want to keep it)
        ' currentPatientPhone = ""
    End Sub

    Private Sub LoadPatientData()
        Try
            Dim patientsFilePath As String = GlobalVariables.GetFilePath("patients.txt")
            Dim schedulesFilePath As String = GlobalVariables.GetFilePath("schedules.txt")

            ' Check if files exist
            If Not File.Exists(schedulesFilePath) Then
                MessageBox.Show("Please book an appointment first!", "No Appointment",
                              MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Me.Hide()
                Return
            End If

            ' Load schedule data to check appointment
            scheduleData = Nothing
            If File.Exists(schedulesFilePath) Then
                Dim scheduleLines = File.ReadAllLines(schedulesFilePath)
                For Each line In scheduleLines
                    Dim fields = line.Split("|"c)
                    If fields.Length >= 8 AndAlso fields(1).Trim() = currentPatientPhone.Trim() Then
                        ' Check if appointment is Pending
                        Dim status As String = "Pending"
                        If fields.Length >= 8 Then
                            status = fields(7).Trim()
                        End If

                        If status = "Pending" Then
                            scheduleData = fields
                            Exit For
                        End If
                    End If
                Next
            End If

            ' If no PENDING appointment found
            If scheduleData Is Nothing Then
                MessageBox.Show("No PENDING appointment found. All appointments may already be completed.",
                              "No Pending Appointments", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Me.Hide()
                Return
            End If

            ' Load patient data only if appointment exists
            patientData = Nothing
            If File.Exists(patientsFilePath) Then
                Dim patientLines = File.ReadAllLines(patientsFilePath)
                For Each line In patientLines
                    Dim fields = line.Split("|"c)
                    If fields.Length >= 15 AndAlso fields(13).Trim() = currentPatientPhone.Trim() Then
                        ' Check if patient is Pending
                        Dim patientStatus As String = "Pending"
                        If fields.Length >= 15 Then
                            patientStatus = fields(14).Trim()
                        End If

                        If patientStatus = "Pending" Then
                            patientData = fields
                            txtFullName.Text = fields(1)
                            txtPhoneNumber.Text = fields(13)
                            Exit For
                        End If
                    End If
                Next
            End If

            ' If no PENDING patient found
            If patientData Is Nothing Then
                MessageBox.Show("No PENDING patient data found! All patient records may already be completed.",
                              "No Pending Patients", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Me.Hide()
                Return
            End If

            ' If all data loaded successfully, calculate billing
            CalculateVitaminsAndBilling()

        Catch ex As Exception
            MessageBox.Show("Error loading patient data: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
            Me.Hide()
        End Try
    End Sub

    Private Sub CalculateVitaminsAndBilling()
        If patientData Is Nothing OrElse patientData.Length < 15 Then
            MessageBox.Show("Patient data not found!")
            Return
        End If

        If scheduleData Is Nothing Then
            MessageBox.Show("No appointment data found!")
            Return
        End If

        Try
            ' Get next visit date from patient data
            Dim nextVisitDateStr As String = patientData(12).Trim()
            Dim nextVisitDate As DateTime

            ' Try parsing with different date formats
            If Not DateTime.TryParseExact(nextVisitDateStr, "MM/dd/yyyy", Nothing, Globalization.DateTimeStyles.None, nextVisitDate) Then
                If Not DateTime.TryParseExact(nextVisitDateStr, "M/d/yyyy", Nothing, Globalization.DateTimeStyles.None, nextVisitDate) Then
                    nextVisitDate = DateTime.Parse(nextVisitDateStr)
                End If
            End If

            ' Get appointment date from schedule data
            Dim appointmentDate As DateTime = DateTime.Now
            If scheduleData.Length >= 5 Then
                Dim appointmentDateStr As String = scheduleData(4).Trim()
                If Not String.IsNullOrEmpty(appointmentDateStr) Then
                    If Not DateTime.TryParseExact(appointmentDateStr, "MM/dd/yyyy", Nothing, Globalization.DateTimeStyles.None, appointmentDate) Then
                        If Not DateTime.TryParseExact(appointmentDateStr, "M/d/yyyy", Nothing, Globalization.DateTimeStyles.None, appointmentDate) Then
                            appointmentDate = DateTime.Parse(appointmentDateStr)
                        End If
                    End If
                End If
            End If

            ' Calculate days until next visit
            Dim daysUntilNextVisit As Integer = (nextVisitDate - appointmentDate).Days
            If daysUntilNextVisit < 0 Then
                daysUntilNextVisit = 0
            End If

            txtVisit.Text = daysUntilNextVisit.ToString()

            ' Initialize total amount
            totalAmountDue = 0
            visitTypePrice = 0

            ' Get visit type from schedule data
            Dim visitType As String = ""
            If scheduleData.Length >= 7 Then
                visitType = scheduleData(6).Trim()
            End If

            ' Set checkboxes based on visit type
            If visitType.ToLower().Contains("initial") Then
                chbInitial.Checked = True
                chbFollow.Checked = False
                visitTypePrice = paymentTable("Initial Check up")
                totalAmountDue += visitTypePrice
                txtVisitPrice.Text = $"₱{visitTypePrice:N2}"
                CalculateVitaminQuantities(daysUntilNextVisit, includeFluVaccine:=True)

            ElseIf visitType.ToLower().Contains("follow") Then
                chbFollow.Checked = True
                chbInitial.Checked = False
                visitTypePrice = paymentTable("Follow up Check-Up")
                totalAmountDue += visitTypePrice
                txtVisitPrice.Text = $"₱{visitTypePrice:N2}"
                CalculateVitaminQuantities(daysUntilNextVisit, includeFluVaccine:=False)
            Else
                MessageBox.Show("Invalid visit type in appointment data!", "Error",
                              MessageBoxButtons.OK, MessageBoxIcon.Error)
                Return
            End If

            ' Update total amounts
            txtTotal.Text = $"₱{totalAmountDue:N2}"
            txtTotalAmt.Text = $"₱{totalAmountDue:N2}"
            txtStatus.Text = "Pending"

        Catch ex As Exception
            MessageBox.Show($"Error calculating vitamins and billing: {ex.Message}",
                          "Error", MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub CalculateVitaminQuantities(daysUntilNextVisit As Integer, includeFluVaccine As Boolean)
        ' Iron Vitamin (once per day)
        Dim ironQuantity As Integer = daysUntilNextVisit
        Dim ironCost As Decimal = ironQuantity * paymentTable("Iron Vitamin")
        txtIronVitamin.Text = $"{ironQuantity} pcs"
        txtIronVitaminPrice.Text = $"₱{ironCost:N2}"

        ' B Complex (once per day)
        Dim bComplexQuantity As Integer = daysUntilNextVisit
        Dim bComplexCost As Decimal = bComplexQuantity * paymentTable("B Complex")
        txtBComplex.Text = $"{bComplexQuantity} pcs"
        txtBComplexPrice.Text = $"₱{bComplexCost:N2}"

        ' DHA (three times per day)
        Dim dhaQuantity As Integer = daysUntilNextVisit * 3
        Dim dhaCost As Decimal = dhaQuantity * paymentTable("DHA")
        txtDHA.Text = $"{dhaQuantity} pcs"
        txtDHAPrice.Text = $"₱{dhaCost:N2}"

        ' Flu Vaccine (only if included and only once)
        If includeFluVaccine Then
            txtFluVaccine.Text = "1 pc"
            txtFluVaccinePrice.Text = $"₱{paymentTable("Flu Vac"):N2}"
        Else
            txtFluVaccine.Text = "0 pcs"
            txtFluVaccinePrice.Text = "₱0.00"
        End If
    End Sub

    Private Sub CalculateChange(sender As Object, e As EventArgs)
        Try
            If Decimal.TryParse(txtAmtPaid.Text.Replace("₱", "").Trim(), Nothing) Then
                Dim amountPaid As Decimal = Decimal.Parse(txtAmtPaid.Text.Replace("₱", "").Trim())
                Dim change As Decimal = amountPaid - totalAmountDue
                txtChange.Text = $"₱{change:N2}"

                If change < 0 Then
                    txtChange.ForeColor = Color.Red
                Else
                    txtChange.ForeColor = Color.Green
                End If
            Else
                txtChange.Text = "₱0.00"
                txtChange.ForeColor = Color.Black
            End If
        Catch ex As Exception
            txtChange.Text = "₱0.00"
        End Try
    End Sub

    Private Sub SaveBillingToFile()
        Try
            Dim billingFilePath As String = GlobalVariables.GetFilePath("billing.txt")

            ' Get visit type from schedule data
            Dim visitType As String = ""
            If scheduleData IsNot Nothing AndAlso scheduleData.Length >= 7 Then
                visitType = scheduleData(6).Trim()
            End If

            ' Get prescribed vitamins
            Dim vitamins As String = GetPrescribedVitamins()

            ' Get payment amount
            Dim paymentAmount As String = "0.00"
            If Not String.IsNullOrEmpty(txtAmtPaid.Text) Then
                paymentAmount = txtAmtPaid.Text.Replace("₱", "").Trim()
            End If

            ' Create billing record with status field
            ' Format: PatientName|PhoneNumber|VisitType|VisitPrice|Vitamins|TotalAmount|AmountPaid|PaymentDate|Status
            Dim billingRecord As String = $"{txtFullName.Text}|" &
                                         $"{txtPhoneNumber.Text}|" &
                                         $"{visitType}|" &
                                         $"{visitTypePrice}|" &
                                         $"{vitamins}|" &
                                         $"{totalAmountDue}|" &
                                         $"{paymentAmount}|" &
                                         $"{DateTime.Now:MM/dd/yyyy HH:mm}|" &
                                         $"{"Pending"}"  ' Status field - initially "Pending"

            ' Save to file
            Using writer As New StreamWriter(billingFilePath, True)
                writer.WriteLine(billingRecord)
            End Using

        Catch ex As Exception
            MessageBox.Show("Error saving billing record: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' Update billing status to "Complete"
    Private Sub UpdateBillingStatus()
        Try
            Dim billingFilePath As String = GlobalVariables.GetFilePath("billing.txt")
            If Not File.Exists(billingFilePath) Then Return

            Dim lines As String() = File.ReadAllLines(billingFilePath)
            Dim updatedLines As New List(Of String)
            Dim foundBillingRecord As Boolean = False

            For Each line As String In lines
                If line.Trim() <> "" Then
                    Dim fields As String() = line.Split("|"c)

                    ' Check if this is the current patient's most recent Pending billing record
                    ' Format: PatientName|PhoneNumber|VisitType|VisitPrice|Vitamins|TotalAmount|AmountPaid|PaymentDate|Status
                    If fields.Length >= 9 AndAlso
                       fields(1).Trim() = currentPatientPhone.Trim() AndAlso
                       fields(8).Trim() = "Pending" AndAlso
                       Not foundBillingRecord Then

                        ' Update status to "Complete"
                        fields(8) = "Completed"
                        foundBillingRecord = True

                        ' Reconstruct the line with updated status
                        Dim updatedLine As String = String.Join("|", fields)
                        updatedLines.Add(updatedLine)
                    Else
                        updatedLines.Add(line)
                    End If
                End If
            Next

            ' Write updated lines back to file
            File.WriteAllLines(billingFilePath, updatedLines)

        Catch ex As Exception
            MessageBox.Show("Error updating billing status: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Function GetPrescribedVitamins() As String
        Dim vitamins As New List(Of String)

        If txtIronVitamin.Text <> "0 pcs" AndAlso txtIronVitamin.Text <> "" Then
            vitamins.Add("Iron Vitamin")
        End If
        If txtBComplex.Text <> "0 pcs" AndAlso txtBComplex.Text <> "" Then
            vitamins.Add("B Complex")
        End If
        If txtDHA.Text <> "0 pcs" AndAlso txtDHA.Text <> "" Then
            vitamins.Add("DHA")
        End If
        If txtFluVaccine.Text <> "0 pcs" AndAlso txtFluVaccine.Text <> "" Then
            vitamins.Add("Flu Vaccine")
        End If

        Return String.Join(", ", vitamins)
    End Function

    ' Update status in schedules.txt to "Completed"
    Private Sub UpdateScheduleStatus()
        Try
            Dim schedulesFilePath As String = GlobalVariables.GetFilePath("schedules.txt")
            If Not File.Exists(schedulesFilePath) Then Return

            Dim lines As String() = File.ReadAllLines(schedulesFilePath)
            Dim updatedLines As New List(Of String)

            For Each line As String In lines
                If line.Trim() <> "" Then
                    Dim fields As String() = line.Split("|"c)

                    ' Check if this is the current user's Pending appointment
                    If fields.Length >= 8 AndAlso
                       fields(1).Trim() = currentPatientPhone.Trim() AndAlso
                       fields(7).Trim() = "Pending" Then

                        ' Update status to "Completed"
                        fields(7) = "Completed"

                        ' Reconstruct the line with updated status
                        Dim updatedLine As String = String.Join("|", fields)
                        updatedLines.Add(updatedLine)
                    Else
                        updatedLines.Add(line)
                    End If
                End If
            Next

            ' Write updated lines back to file
            File.WriteAllLines(schedulesFilePath, updatedLines)

        Catch ex As Exception
            MessageBox.Show("Error updating appointment status: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    ' Update status in patients.txt to "Completed"
    Private Sub UpdatePatientStatus()
        Try
            Dim patientsFilePath As String = GlobalVariables.GetFilePath("patients.txt")
            If Not File.Exists(patientsFilePath) Then Return

            Dim lines As String() = File.ReadAllLines(patientsFilePath)
            Dim updatedLines As New List(Of String)

            For Each line As String In lines
                If line.Trim() <> "" Then
                    Dim fields As String() = line.Split("|"c)

                    ' Check if this is the current user's Pending patient record
                    If fields.Length >= 15 AndAlso
                       fields(13).Trim() = currentPatientPhone.Trim() AndAlso
                       fields(14).Trim() = "Pending" Then

                        ' Update status to "Completed"
                        fields(14) = "Completed"

                        ' Reconstruct the line with updated status
                        Dim updatedLine As String = String.Join("|", fields)
                        updatedLines.Add(updatedLine)
                    Else
                        updatedLines.Add(line)
                    End If
                End If
            Next

            ' Write updated lines back to file
            File.WriteAllLines(patientsFilePath, updatedLines)

        Catch ex As Exception
            MessageBox.Show("Error updating patient status: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub btnCompleteBP_Click(sender As Object, e As EventArgs) Handles btnCompleteBP.Click
        Try
            ' Validate payment amount
            If String.IsNullOrEmpty(txtAmtPaid.Text) OrElse Not Decimal.TryParse(txtAmtPaid.Text.Replace("₱", "").Trim(), Nothing) Then
                MessageBox.Show("Please enter a valid payment amount before completing.",
                              "Payment Required", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            Dim amountPaid As Decimal = Decimal.Parse(txtAmtPaid.Text.Replace("₱", "").Trim())
            If amountPaid < totalAmountDue Then
                MessageBox.Show("Insufficient payment. Please enter the full amount.",
                              "Insufficient Payment", MessageBoxButtons.OK, MessageBoxIcon.Warning)
                Return
            End If

            ' Update form status
            txtStatus.Text = "Completed"

            ' Save billing record initially with "Pending" status
            SaveBillingToFile()

            ' Update all statuses to "Complete" or "Completed"
            UpdateBillingStatus()   ' Updates billing.txt status from "Pending" to "Complete"
            UpdateScheduleStatus()  ' Updates schedules.txt status from "Pending" to "Completed"
            UpdatePatientStatus()   ' Updates patients.txt status from "Pending" to "Completed"

            ' Show success message with change
            Dim change As Decimal = amountPaid - totalAmountDue
            MessageBox.Show($"Payment completed successfully!{Environment.NewLine}" &
                          $"Total: ₱{totalAmountDue:N2}{Environment.NewLine}" &
                          $"Paid: ₱{amountPaid:N2}{Environment.NewLine}" &
                          $"Change: ₱{change:N2}{Environment.NewLine}" &
                          $"Status updated to 'Complete' in all records.",
                          "Payment Complete", MessageBoxButtons.OK, MessageBoxIcon.Information)

            ' Mark payment as completed
            paymentCompleted = True

            ' Clear form
            ClearForm()

            ' Show message that form is reset
            MessageBox.Show("Payment completed and form has been reset. Please book a new appointment for your next visit.",
                          "Form Reset", MessageBoxButtons.OK, MessageBoxIcon.Information)

            ' Close the form since payment is done
            Me.Close()
            PatientMenuForm.Show()

        Catch ex As Exception
            MessageBox.Show("Error completing billing: " & ex.Message, "Error",
                          MessageBoxButtons.OK, MessageBoxIcon.Error)
        End Try
    End Sub

    Private Sub chbInitial_CheckedChanged(sender As Object, e As EventArgs) Handles chbInitial.CheckedChanged
        If chbInitial.Checked Then
            chbFollow.Checked = False
        End If
    End Sub

    Private Sub chbFollow_CheckedChanged(sender As Object, e As EventArgs) Handles chbFollow.CheckedChanged
        If chbFollow.Checked Then
            chbInitial.Checked = False
        End If
    End Sub

    Private Sub btnBack_Click(sender As Object, e As EventArgs) Handles btnBack.Click
        Me.Close()
        PatientMenuForm.Show()
    End Sub

    ' Add this method to handle form closing
    Private Sub BillingAndPaymentForm_FormClosing(sender As Object, e As FormClosingEventArgs) Handles MyBase.FormClosing
        ' Clear all data when form is closing
        ClearForm()
        paymentCompleted = False
    End Sub
End Class